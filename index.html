<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YP Conference Portal - Night Edition</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* == NIGHT DESIGN VARIABLES == */
        :root {
            --bg-color: #121212;
            --sidebar-bg: #1e1e1e;
            --card-bg: #252525;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
            --border-color: #333333;
            --danger-color: #ef4444;
            --success-color: #10b981;
            
            --sidebar-width: 260px;
            --header-height: 70px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* == ANIMATIONS == */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        /* == SIDEBAR == */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100%;
            z-index: 100;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-header {
            height: var(--header-height);
            display: flex;
            align-items: center;
            padding: 0 1.5rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent-color);
            letter-spacing: 1px;
        }

        .sidebar-menu {
            flex-grow: 1;
            padding: 1.5rem 1rem;
            overflow-y: auto;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.85rem 1rem;
            margin-bottom: 0.5rem;
            color: var(--text-muted);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background-color: rgba(59, 130, 246, 0.1);
            color: var(--text-main);
            padding-left: 1.25rem;
        }

        .nav-item.active {
            background-color: rgba(59, 130, 246, 0.15);
            color: var(--accent-color);
            border-left: 3px solid var(--accent-color);
            font-weight: 600;
        }

        .nav-item i {
            width: 24px;
            margin-right: 10px;
            text-align: center;
        }

        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
        }

        /* == MAIN CONTENT == */
        .main-wrapper {
            flex-grow: 1;
            margin-left: var(--sidebar-width);
            display: flex;
            flex-direction: column;
            height: 100vh;
            transition: margin-left 0.3s ease;
        }

        .top-header {
            height: var(--header-height);
            background-color: var(--bg-color);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .header-title { font-size: 1.2rem; font-weight: 600; }

        .search-box { position: relative; margin-left: auto; margin-right: 20px; }
        .search-box input {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            padding: 0.5rem 1rem 0.5rem 2.5rem;
            border-radius: 20px;
            width: 200px;
            transition: width 0.3s ease, border-color 0.3s;
        }
        .search-box input:focus { outline: none; width: 280px; border-color: var(--accent-color); }
        .search-box i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 0.8rem; }

        .auth-btn {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-main);
            padding: 0.4rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .auth-btn:hover { background-color: var(--card-bg); border-color: var(--accent-color); }
        .auth-btn.primary { background-color: var(--accent-color); border-color: var(--accent-color); color: white; }
        .auth-btn.primary:hover { background-color: var(--accent-hover); }
        .auth-btn.success { background-color: var(--success-color); border-color: var(--success-color); color: white; }
        .auth-btn.success:hover { background-color: #0c8a5e; }


        .content-container { flex-grow: 1; overflow-y: auto; padding: 2rem; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }

        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); border-color: var(--accent-color); }
        .card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: var(--accent-color); transform: scaleX(0); transform-origin: left; transition: transform 0.3s ease;
        }
        .card:hover::before { transform: scaleX(1); }
        .card h3 { margin-bottom: 0.5rem; color: var(--text-main); }
        .card p { color: var(--text-muted); font-size: 0.9rem; line-height: 1.5; margin-bottom: 1rem; }
        img.logo {
    width: 47px;
    border-radius: 184px;
    margin-left: 8px;
    margin: 10px;
}


        /* Image in Card */
        .card-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 1rem;
            background-color: #333;
        }

        /* Form Styling */
        .form-group { margin-bottom: 1.2rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-muted); }
        .form-input {
            width: 100%; background-color: var(--bg-color); border: 1px solid var(--border-color);
            color: var(--text-main); padding: 0.8rem; border-radius: 6px; font-family: inherit;
        }
        .form-input:focus { outline: none; border-color: var(--accent-color); }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            z-index: 1000; display: none; justify-content: center; align-items: center;
        }
        .modal {
            background-color: var(--card-bg); width: 100%; max-width: 500px;
            padding: 2rem; border-radius: 12px; border: 1px solid var(--border-color);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); animation: fadeIn 0.3s ease;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .close-modal { background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; }

        /* Dashboard Specifics */
        .dashboard-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .hero-card {
            background: linear-gradient(145deg, var(--card-bg), #2a2a2a);
            border: 1px solid var(--accent-color);
            position: relative;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .hero-card .new-badge {
            position: absolute; top: 1rem; right: 1rem;
            background-color: var(--accent-color); color: white;
            padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.4);
        }

        .schedule-list-item {
            display: flex; gap: 1rem; padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        .schedule-list-item:last-child { border-bottom: none; }
        .schedule-time { color: var(--accent-color); font-weight: 600; min-width: 60px; }

        /* Mobile */
        .menu-toggle { display: none; font-size: 1.5rem; color: var(--text-main); background: none; border: none; cursor: pointer; margin-right: 1rem; }
        .hidden { display: none !important; }
        .badge { background-color: var(--accent-color); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; margin-left: auto; }
        
        /* Admin Actions */
        .admin-controls {
            display: flex; gap: 10px; margin-top: 15px; border-top: 1px solid var(--border-color); padding-top: 10px;
        }
        .btn-sm { padding: 4px 10px; font-size: 0.8rem; }
        .btn-danger { background-color: transparent; border: 1px solid var(--danger-color); color: var(--danger-color); }
        .btn-danger:hover { background-color: var(--danger-color); color: white; }

        @media (max-width: 900px) {
            .dashboard-layout { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
            .main-wrapper { margin-left: 0; }
            .menu-toggle { display: block; }
            .top-header { padding: 0 1rem; }
        }
    </style>
</head>
<body>

    <!-- Sidebar Navigation -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img class="logo" src="LOGO.png" alt=""> YP Portal
        </div>
        
        <div class="sidebar-menu">
            <!-- User Menu Items -->
            <a href="#" class="nav-item active" onclick="showSection('dashboard', this)">
                <i class="fas fa-home"></i> <span>Dashboard</span>
            </a>
            <!-- Kept Schedule as a separate detailed view, but it's also on dashboard now -->
            <a href="#" class="nav-item" onclick="showSection('schedule_full', this)">
                <i class="fas fa-calendar-alt"></i> <span>Full Schedule</span>
            </a>
            <a href="#" class="nav-item" onclick="showSection('registration', this)">
                <i class="fas fa-user-plus"></i> <span>Registration</span>
            </a>
            <a href="#" class="nav-item" onclick="showSection('settings', this)">
                <i class="fas fa-cog"></i> <span>Settings</span>
            </a>

            <!-- Admin Menu Items (Hidden by default) -->
            <div id="adminLinks" class="hidden" style="margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 1rem;">
                <p style="padding: 0 1rem; margin-bottom: 0.5rem; font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); letter-spacing: 1px;">Admin Panel</p>
                <a href="#" class="nav-item" onclick="showSection('admin_yps', this)">
                    <i class="fas fa-users"></i> <span>Manage YPs</span>
                    <span class="badge" id="ypCountBadge">0</span>
                </a>
                <a href="#" class="nav-item" onclick="showSection('admin_announcements', this)">
                    <i class="fas fa-edit"></i> <span>Manage News</span>
                </a>
            </div>
        </div>

        <div class="sidebar-footer">
            <!-- Authentication buttons controlled by JS -->
            <div id="authControls">
                <!-- 1. Admin Login Button (Visible if admin account exists and user is logged out) -->
                <button id="adminLoginBtn" class="auth-btn primary" style="width: 100%" onclick="openLoginModal()">
                    <i class="fas fa-sign-in-alt"></i> Admin Login
                </button>
                <!-- 2. First Admin Setup Button (Visible only if NO admin account exists) -->
                <button id="adminSetupBtn" class="auth-btn success hidden" style="width: 100%;" onclick="openSetupModal()">
                    <i class="fas fa-user-plus"></i> Register First Admin
                </button>
                <!-- 3. Logout Button (Visible if admin is logged in) -->
                <button id="logoutBtn" class="auth-btn hidden" style="width: 100%; border-color: var(--danger-color); color: var(--danger-color);" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Content Wrapper -->
    <div class="main-wrapper">
        
        <!-- Top Header -->
        <header class="top-header">
            <div style="display: flex; align-items: center;">
                <button class="menu-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="header-title" id="pageTitle">Dashboard</h1>
            </div>

            <div style="display: flex; align-items: center;">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <!-- id="searchInput" for filtering YPs when that section is active -->
                    <input type="text" placeholder="Search..." id="searchInput">
                </div>
                <div style="width: 35px; height: 35px; background: var(--card-bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border-color); cursor: default;">
                    <i class="fas fa-user" style="color: var(--text-muted);"></i>
                </div>
            </div>
        </header>

        <!-- Dynamic Content Area -->
        <main class="content-container">

            <!-- 1. DASHBOARD SECTION (Combined Announcements + Schedule) -->
            <section id="dashboard" class="fade-in">
                <!-- Top Row: Latest News + Today's Schedule -->
                <div class="dashboard-layout">
                    
                    <!-- Latest Announcement (Featured) -->
                    <div id="latestAnnouncementContainer">
                         <!-- Loading State -->
                        <div class="card hero-card">
                            <h3><i class="fas fa-spinner fa-spin"></i> Checking for updates...</h3>
                        </div>
                    </div>

                    <!-- Quick Schedule -->
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem;">
                            <h3><i class="fas fa-clock text-accent"></i> Upcoming</h3>
                            <a href="#" onclick="showSection('schedule_full', document.querySelectorAll('.nav-item')[1])" style="font-size: 0.8rem; color: var(--accent-color); text-decoration: none;">View All</a>
                        </div>
                        <div id="quickScheduleList">
                             <div class="schedule-list-item">
                                <span class="schedule-time">15:00</span>
                                <div>
                                    <h5 style="margin-bottom: 0.2rem; font-size: 0.95rem;">Arrival & Registration</h5>
                                    <p style="margin: 0; font-size: 0.8rem; color: var(--text-muted);">Main Hall Lobby</p>
                                </div>
                            </div>
                            <div class="schedule-list-item">
                                <span class="schedule-time">16:30</span>
                                <div>
                                    <h5 style="margin-bottom: 0.2rem; font-size: 0.95rem;">Opening Session</h5>
                                    <p style="margin: 0; font-size: 0.8rem; color: var(--text-muted);">Conference Hall</p>
                                </div>
                            </div>
                             <div class="schedule-list-item">
                                <span class="schedule-time">18:00</span>
                                <div>
                                    <h5 style="margin-bottom: 0.2rem; font-size: 0.95rem;">Love Feast (Dinner)</h5>
                                    <p style="margin: 0; font-size: 0.8rem; color: var(--text-muted);">Dining Area</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <h3 style="margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem;">Previous Announcements</h3>
                <div class="grid" id="olderAnnouncementsGrid">
                    <p style="color: var(--text-muted);">No older announcements.</p>
                </div>
            </section>

            <!-- 2. FULL SCHEDULE SECTION -->
            <section id="schedule_full" class="hidden fade-in">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem;">
                        <h3><i class="fas fa-calendar-day text-accent"></i> Friday</h3>
                        <span style="color: var(--text-muted);">Oct 25, 2024</span>
                    </div>
                    <div style="display: grid; gap: 1rem;">
                        <div style="display: flex; gap: 1rem;">
                            <span style="min-width: 80px; color: var(--accent-color); font-weight: 600;">15:00</span>
                            <div>
                                <h4 style="margin-bottom: 0.2rem;">Arrival & Registration</h4>
                                <p style="margin: 0; font-size: 0.85rem;">Main Hall Lobby</p>
                            </div>
                        </div>
                         <div style="display: flex; gap: 1rem;">
                            <span style="min-width: 80px; color: var(--accent-color); font-weight: 600;">16:30</span>
                            <div>
                                <h4 style="margin-bottom: 0.2rem;">Opening Session</h4>
                                <p style="margin: 0; font-size: 0.85rem;">Message 1</p>
                            </div>
                        </div>
                        <div style="display: flex; gap: 1rem;">
                            <span style="min-width: 80px; color: var(--accent-color); font-weight: 600;">18:00</span>
                            <div>
                                <h4 style="margin-bottom: 0.2rem;">Love Feast</h4>
                                <p style="margin: 0; font-size: 0.85rem;">Dinner Together</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 3. REGISTRATION SECTION -->
            <section id="registration" class="hidden fade-in">
                <div class="card" style="max-width: 600px; margin: 0 auto;">
                    <h3>Conference Registration</h3>
                    <form id="regForm">
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input type="text" id="regName" class="form-input" required>
                        </div>
                        <div style="display: flex; gap: 1rem;">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Gender</label>
                                <select id="regGender" class="form-input" required>
                                    <option value="Brother">Brother</option>
                                    <option value="Sister">Sister</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Age</label>
                                <input type="number" id="regAge" class="form-input" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Year Level / Status</label>
                            <input type="text" id="regYear" class="form-input" placeholder="e.g. Grade 11" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Barangay</label>
                            <input type="text" id="regBarangay" class="form-input" required>
                        </div>
                         <div class="form-group">
                            <label class="form-label">Training Attended</label>
                            <input type="text" id="regTraining" class="form-input" placeholder="e.g. FTTMA (Optional)">
                        </div>
                         <div class="form-group">
                            <label class="form-label">Years in Church Life</label>
                            <input type="text" id="regYearsChurch" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Game to Play (Optional)</label>
                            <input type="text" id="regGame" class="form-input" placeholder="e.g. Basketball">
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="regBaptized"> Baptized?
                            </label>
                        </div>
                         <div class="form-group">
                            <label class="form-label">Profile Photo (Optional)</label>
                            <input type="file" id="regImage" class="form-input" accept="image/*">
                        </div>
                        <button type="submit" class="auth-btn primary" style="width: 100%;" id="regSubmitBtn">Submit Registration</button>
                    </form>
                </div>
            </section>

            <!-- 4. SETTINGS SECTION -->
            <section id="settings" class="hidden fade-in">
                <div class="card" style="max-width: 600px;">
                    <h3><i class="fas fa-cog"></i> Settings</h3>
                    <div style="margin-top: 1rem;">
                        <p>Theme: Night Mode (Default)</p>
                    </div>
                </div>
            </section>

            <!-- 5. ADMIN: MANAGE YPS -->
            <section id="admin_yps" class="hidden fade-in">
                
                <!-- YP Form (Collapsible) -->
                <div class="card" style="margin-bottom: 2rem;">
                    <h3>Add / Edit YP Profile</h3>
                    <form id="ypForm">
                        <input type="hidden" id="ypEditId">
                        <div class="form-group">
                            <label class="form-label">Name</label>
                            <input type="text" id="ypName" class="form-input" required>
                        </div>
                         <div class="form-group">
                            <label class="form-label">Barangay</label>
                            <input type="text" id="ypBarangay" class="form-input" required>
                        </div>
                        <div style="display: flex; gap: 1rem;">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Gender</label>
                                <select id="ypGender" class="form-input">
                                    <option value="Brother">Brother</option>
                                    <option value="Sister">Sister</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Status</label>
                                <input type="text" id="ypStatus" class="form-input" placeholder="e.g. Student" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Photo</label>
                            <input type="file" id="ypImage" class="form-input" accept="image/*">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="submit" class="auth-btn primary" id="ypSaveBtn">Save Profile</button>
                            <button type="button" class="auth-btn" id="ypCancelBtn" style="display: none;" onclick="resetYPForm()">Cancel</button>
                        </div>
                    </form>
                </div>

                <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                    <h3>All Young People</h3>
                </div>
                <div class="grid" id="ypGrid">
                    <p>Loading YP Profiles...</p>
                </div>
            </section>

             <!-- 6. ADMIN: MANAGE ANNOUNCEMENTS -->
             <section id="admin_announcements" class="hidden fade-in">
                <div class="card" style="margin-bottom: 2rem;">
                    <h3 id="formTitle">Create New Announcement</h3>
                    <form id="announcementForm">
                        <input type="hidden" id="editId">
                        <div class="form-group">
                            <label class="form-label">Title</label>
                            <input type="text" id="annTitle" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Content</label>
                            <textarea id="annContent" class="form-input" rows="3" required></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Picture</label>
                            <input type="file" id="annImage" class="form-input" accept="image/*">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="submit" class="auth-btn primary" id="saveBtn">Post Announcement</button>
                            <button type="button" class="auth-btn" id="cancelBtn" style="display: none;" onclick="resetForm()">Cancel</button>
                        </div>
                    </form>
                </div>

                <h3>Existing Announcements</h3>
                <div class="grid" id="adminAnnouncementList">
                    <!-- Loaded dynamically -->
                </div>
            </section>

        </main>
    </div>

    <!-- 1. LOGIN Modal (Regular Admin Sign In) -->
    <div class="modal-overlay" id="loginModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Admin Login</h3>
                <button class="close-modal" onclick="closeLoginModal()">&times;</button>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="email" class="form-input" placeholder="admin@example.com" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="password" class="form-input" placeholder="********" required>
                </div>
                <p id="loginError" style="color: var(--danger-color); font-size: 0.8rem; margin-bottom: 1rem; display: none;"></p>
                <button type="submit" class="auth-btn primary" style="width: 100%" id="loginSubmitBtn">Sign In</button>
            </form>
        </div>
    </div>
    
    <!-- 2. SIGN UP / SETUP Modal (First-Time Admin Registration) -->
    <div class="modal-overlay" id="setupModal">
        <div class="modal">
            <div class="modal-header">
                <h3>First-Time Admin Registration</h3>
                <button class="close-modal" onclick="closeSetupModal()">&times;</button>
            </div>
            <form id="setupForm">
                <p style="margin-bottom: 1rem; color: var(--text-muted);">
                    Create the first administrator account (Sign Up). This user will have full access.
                </p>
                <div class="form-group">
                    <label class="form-label">Admin Email</label>
                    <input type="email" id="setupEmail" class="form-input" placeholder="admin@example.com" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="setupPassword" class="form-input" placeholder="********" required minlength="6">
                </div>
                <p id="setupError" style="color: var(--danger-color); font-size: 0.8rem; margin-bottom: 1rem; display: none;"></p>
                <button type="submit" class="auth-btn success" style="width: 100%;" id="setupSubmitBtn">Create Admin & Login</button>
            </form>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://lwuxjarsdoibzsoqqhmq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3dXhqYXJzZG9pYnpzb3FxaG1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3NDU0NTgsImV4cCI6MjA4MDMyMTQ1OH0.Yf1sqFN-PwFAqMP6tqaKXE2kjvd0I0F_OxrFOANQqu4';
        const BUCKET_NAME = 'yp-conference-images';
           
        const { createClient } = supabase;
        const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // === STATE ===
        let currentUser = null;
        let isAdmin = false;

        // === UTILITIES ===
        let debounceTimer;
        function debounce(func, delay) {
            return function(...args) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // === INITIALIZATION & AUTH UI SETUP ===
        window.addEventListener('load', () => {
            fetchAnnouncements(); // Public load
            // Fetch YPs initially to populate the badge count for public
            fetchYPs(''); 
            initializeAuthAndUI();
            
            // Add event listener for search input with debounce
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', debounce((e) => {
                // Only trigger YP search if the admin YP section is currently visible
                const adminYPsSection = document.getElementById('admin_yps');
                if (adminYPsSection && !adminYPsSection.classList.contains('hidden')) {
                    // Search in YP admin section
                    fetchYPs(e.target.value);
                } else {
                    console.log("Search is currently only active in 'Manage YPs' section.");
                }
            }, 300));
        });

        // Helper to check if any admin exists in the public.admin_users table
        async function checkAdminExists() {
            const { count, error } = await sb
                .from('admin_users')
                .select('*', { count: 'exact', head: true });

            if (error) {
                console.error("Error checking admin count:", error);
                return true; // Fail safe, assume admin exists if error occurs
            }
            return count > 0;
        }

        async function initializeAuthAndUI() {
            const isAdminPresent = await checkAdminExists();
            // Renamed elements for clarity:
            const adminSetupBtn = document.getElementById('adminSetupBtn');
            const adminLoginBtn = document.getElementById('adminLoginBtn');
            const logoutBtn = document.getElementById('logoutBtn');

            // 1. Determine which login button to show (Setup vs. Regular Login)
            if (!isAdminPresent) {
                // If no admin exists, show setup button, hide login button
                adminLoginBtn.classList.add('hidden');
                adminSetupBtn.classList.remove('hidden');
            } else {
                // Admin exists, show regular login button, hide setup button
                adminLoginBtn.classList.remove('hidden');
                adminSetupBtn.classList.add('hidden');
            }

            // 2. Check for an active session
            const { data: { session } } = await sb.auth.getSession();
            
            if (session) {
                // User is logged in, verify if they are an admin
                handleUserLogin(session.user);
            } else {
                // Not logged in. Ensure logout is hidden.
                logoutBtn.classList.add('hidden');
                // If not logged in, ensure only the correct login/setup button is visible (handled in step 1)
            }
        }

        async function handleUserLogin(user) {
            currentUser = user;
            
            // Check admin_users table for admin flag
            const { data, error } = await sb
                .from('admin_users')
                .select('is_admin')
                .eq('id', user.id)
                .single();

            // PGRST116 means no rows found (not admin) - this is expected for non-admins
            if (error && error.code !== 'PGRST116') { 
                console.error("Error checking admin status:", error);
            }

            if (data && data.is_admin) {
                isAdmin = true;
                enableAdminMode();
                closeLoginModal();
                closeSetupModal();
            } else {
                // Logged in user is NOT an admin.
                console.warn("User is logged in but not an administrator. Signing out.");
                await sb.auth.signOut();
                // Show custom message box instead of alert()
                showUserMessage("You are logged in, but you do not have Admin privileges. Signed out.", 'danger');
                window.location.reload(); 
            }
        }

        function enableAdminMode() {
            document.getElementById('adminLinks').classList.remove('hidden');
            // Hide both login/setup buttons when admin is active
            document.getElementById('adminLoginBtn').classList.add('hidden');
            document.getElementById('adminSetupBtn').classList.add('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');
            
            // Load Admin Data
            fetchAdminAnnouncements();
            // Load YPs for the Admin view
            fetchYPs(''); 
        }

        async function logout() {
            await sb.auth.signOut();
            isAdmin = false;
            currentUser = null;
            window.location.reload(); // Simple way to reset the UI to public view
        }

        // === HELPER: UPLOAD IMAGE ===
        async function uploadImage(fileInputId) {
            if (!isAdmin) {
                throw new Error("Only administrators can upload files.");
            }
            const fileInput = document.getElementById(fileInputId);
            if (fileInput.files.length === 0) return null;

            const file = fileInput.files[0];
            const path = `uploads/${currentUser.id}/${Date.now()}-${file.name}`;
            
            const { data: uploadData, error: uploadError } = await sb.storage
                .from(BUCKET_NAME)
                .upload(path, file);

            if (uploadError) throw uploadError;

            const { data: publicUrlData } = sb.storage
                .from(BUCKET_NAME)
                .getPublicUrl(path);
            
            return publicUrlData.publicUrl;
        }

        // === REGISTRATION LOGIC (Public Access) ===
        document.getElementById('regForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('regSubmitBtn');
            btn.textContent = "Registering...";
            btn.disabled = true;

            try {
                let image_url = null;
                const regImageInput = document.getElementById('regImage');
                // Only attempt upload if a file is present
                if (regImageInput.files.length > 0) {
                     // For public users to upload, RLS on storage must be set to allow anonymous uploads to a specific path
                    const file = regImageInput.files[0];
                    const publicPath = `uploads/registrations/${Date.now()}-${file.name}`;
                    
                    const { data: uploadData, error: uploadError } = await sb.storage
                        .from(BUCKET_NAME)
                        .upload(publicPath, file);

                    if (uploadError) {
                        console.warn("Registration image upload failed (non-critical):", uploadError);
                    } else {
                         const { data: publicUrlData } = sb.storage
                            .from(BUCKET_NAME)
                            .getPublicUrl(publicPath);
                        image_url = publicUrlData.publicUrl;
                    }
                }

                const payload = {
                    name: document.getElementById('regName').value,
                    gender: document.getElementById('regGender').value,
                    age: parseInt(document.getElementById('regAge').value),
                    year_level: document.getElementById('regYear').value,
                    barangay: document.getElementById('regBarangay').value,
                    training_attended: document.getElementById('regTraining').value,
                    years_in_church: document.getElementById('regYearsChurch').value,
                    game_to_play: document.getElementById('regGame').value,
                    baptized: document.getElementById('regBaptized').checked,
                    image_url: image_url
                };

                const { error } = await sb.from('registrations').insert([payload]);
                if(error) throw error;

                // Use custom message box instead of alert()
                showUserMessage("Registration Successful!", 'success');
                document.getElementById('regForm').reset();

            } catch (err) {
                showUserMessage("Error registering: " + err.message, 'danger');
            } finally {
                btn.textContent = "Submit Registration";
                btn.disabled = false;
            }
        });


        // === ANNOUNCEMENT CRUD (Public Read, Admin Write) ===

        // 1. Fetch & Display (Public Dashboard with Prominent Latest + Grid)
        async function fetchAnnouncements() {
            const latestContainer = document.getElementById('latestAnnouncementContainer');
            const olderGrid = document.getElementById('olderAnnouncementsGrid');

            sb.from('announcements')
                .select('*')
                .order('created_at', { ascending: false })
                .then(({ data, error }) => {
                    if (error) {
                        latestContainer.innerHTML = `<p style="color: var(--danger-color)">Error loading announcements</p>`;
                        return;
                    }
                    if (!data || data.length === 0) {
                        latestContainer.innerHTML = `<div class="card hero-card"><p style="color: var(--text-muted)">No announcements posted yet.</p></div>`;
                        olderGrid.innerHTML = '';
                        return;
                    }

                    // 1. FEATURED: The most recent announcement (First item)
                    const latest = data[0];
                    latestContainer.innerHTML = `
                        <div class="card hero-card fade-in">
                            <span class="new-badge">NEW</span>
                            ${latest.pic_url ? `<img src="${latest.pic_url}" class="card-image" style="height: 250px;" alt="Latest News">` : ''}
                            <h2 style="font-size: 1.5rem; margin-bottom: 0.5rem; color: #fff;">${latest.title}</h2>
                            <p style="font-size: 1rem; color: var(--text-main);">${latest.content}</p>
                            <span style="font-size: 0.8rem; color: var(--accent-color); display: block; margin-top: 1rem;">
                                Posted on ${new Date(latest.created_at).toLocaleDateString()}
                            </span>
                        </div>
                    `;

                    // 2. OLDER: The rest of the announcements
                    const older = data.slice(1);
                    if (older.length > 0) {
                        olderGrid.innerHTML = older.map(item => `
                            <div class="card fade-in">
                                ${item.pic_url ? `<img src="${item.pic_url}" class="card-image" alt="Announcement Image">` : ''}
                                <h3>${item.title}</h3>
                                <p>${item.content}</p>
                                <span style="font-size: 0.8rem; color: var(--accent-color);">
                                    ${new Date(item.created_at).toLocaleDateString()}
                                </span>
                            </div>
                        `).join('');
                    } else {
                        olderGrid.innerHTML = `<p style="color: var(--text-muted);">No older announcements.</p>`;
                    }
                });
        }

        // 2. Fetch & Display (Admin List)
        async function fetchAdminAnnouncements() {
            if (!isAdmin) return; // Guard for Admin access
            const container = document.getElementById('adminAnnouncementList');
            const { data } = await sb
                .from('announcements')
                .select('*')
                .order('created_at', { ascending: false });

            if (data) {
                container.innerHTML = data.map(item => `
                    <div class="card">
                        ${item.pic_url ? `<img src="${item.pic_url}" class="card-image" onerror="this.onerror=null;this.src='https://placehold.co/50x50/3b82f6/ffffff?text=YP';" >` : ''}
                        <h3>${item.title}</h3>
                        <p>${item.content}</p>
                        <div class="admin-controls">
                            <button class="auth-btn btn-sm" onclick="editAnnouncement('${item.id}')">Edit</button>
                            <button class="auth-btn btn-danger btn-sm" onclick="deleteAnnouncement('${item.id}')">Delete</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        // 3. Create / Update Announcement
        document.getElementById('announcementForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAdmin) return showUserMessage("You must be logged in as an Admin to post.", 'danger');
            
            const btn = document.getElementById('saveBtn');
            btn.textContent = "Saving...";
            btn.disabled = true;
            
            const id = document.getElementById('editId').value;
            const title = document.getElementById('annTitle').value;
            const content = document.getElementById('annContent').value;
            
            try {
                let pic_url = undefined;
                if(document.getElementById('annImage').files.length > 0) {
                    pic_url = await uploadImage('annImage');
                }

                const payload = { title, content };
                // Only include pic_url in payload if it was actually uploaded/changed
                if (pic_url !== undefined) payload.pic_url = pic_url; 

                if (id) {
                    const { error } = await sb.from('announcements').update(payload).eq('id', id);
                    if(error) throw error;
                    showUserMessage("Announcement updated successfully.", 'success');
                } else {
                    const { error } = await sb.from('announcements').insert([payload]);
                    if(error) throw error;
                    showUserMessage("Announcement posted successfully.", 'success');
                }

                resetForm();
                fetchAdminAnnouncements();
                fetchAnnouncements(); // Refresh public view

            } catch (err) {
                showUserMessage('Error saving: ' + err.message, 'danger');
            } finally {
                btn.textContent = id ? "Update Announcement" : "Post Announcement";
                btn.disabled = false;
            }
        });

        // 4. Delete Announcement
        async function deleteAnnouncement(id) {
            // Using a custom message box instead of confirm()
            if (!isAdmin || !showConfirmation("Are you sure you want to delete this announcement?")) return;
            const { error } = await sb.from('announcements').delete().eq('id', id);
            if (error) showUserMessage('Delete failed: ' + error.message, 'danger');
            else {
                showUserMessage("Announcement deleted.", 'success');
                fetchAdminAnnouncements();
                fetchAnnouncements(); // Refresh public view
            }
        }
        
        // 5. Edit Helper Announcement and resetForm 
        async function editAnnouncement(id) {
            if (!isAdmin) return;
            const { data } = await sb.from('announcements').select('*').eq('id', id).single();
            if(data) {
                document.getElementById('editId').value = data.id;
                document.getElementById('annTitle').value = data.title;
                document.getElementById('annContent').value = data.content;
                // Note: Image editing requires re-uploading the file. The old URL is not displayed here.
                document.getElementById('saveBtn').textContent = "Update Announcement";
                document.getElementById('cancelBtn').style.display = "inline-block";
                document.getElementById('admin_announcements').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function resetForm() {
            document.getElementById('announcementForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('saveBtn').textContent = "Post Announcement";
            document.getElementById('cancelBtn').style.display = "none";
        }


        // === YP PROFILES CRUD (Public Read for badge/list, Admin Write) ===
        
        // 1. Fetch YPs (Works for public count and admin search list)
        async function fetchYPs(searchTerm = '') {
            const container = document.getElementById('ypGrid');
            const isYpAdminView = container && !container.classList.contains('hidden');

            if (isYpAdminView && !isAdmin) {
                 container.innerHTML = `<p style="color: var(--danger-color)">You need to log in as an Admin to manage profiles.</p>`;
                 document.getElementById('ypCountBadge').textContent = '?';
                 return;
            }

            // Only show loading message if it's the admin view
            if (isYpAdminView) {
                container.innerHTML = '<p>Loading YP Profiles...</p>'; 
            }
            
            let query = sb.from('yp_profiles').select('*');

            // Apply search filter if a term is provided
            if (searchTerm) {
                query = query.ilike('name', `%${searchTerm.trim()}%`);
            }
            
            const { data, error } = await query.order('name');

            if (error) {
                console.error("Error loading YP profiles:", error);
                document.getElementById('ypCountBadge').textContent = 'Error';
                if (isYpAdminView) container.innerHTML = `<p style="color: var(--danger-color)">Error loading YP profiles: ${error.message}</p>`;
                return;
            }

            if (data) {
                document.getElementById('ypCountBadge').textContent = data.length;

                // Only render the grid if it's the admin view
                if (isYpAdminView) {
                    if (data.length === 0) {
                         container.innerHTML = `<p style="color: var(--text-muted)">No Young People found matching "${searchTerm}".</p>`;
                         return;
                    }
                    container.innerHTML = data.map(yp => `
                        <div class="card" style="display: flex; align-items: center; gap: 1rem;">
                            <img src="${yp.pic_url || 'https://placehold.co/50x50/3b82f6/ffffff?text=YP'}" onerror="this.onerror=null;this.src='https://placehold.co/50x50/3b82f6/ffffff?text=YP';" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
                            <div style="flex:1;">
                                <h4 style="margin-bottom: 0;">${yp.name}</h4>
                                <p style="margin: 0; font-size: 0.8rem;">${yp.barangay}</p>
                                <p style="margin: 0; font-size: 0.7rem; color: var(--text-muted);">${yp.gender}  ${yp.status}</p>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button class="auth-btn btn-sm" onclick="editYP('${yp.id}')"><i class="fas fa-edit"></i></button>
                                <button class="auth-btn btn-danger btn-sm" onclick="deleteYP('${yp.id}')"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `).join('');
                }
            }
        }

        // 2. Add/Edit YP (Admin Only)
        document.getElementById('ypForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAdmin) return showUserMessage("Admin login required to save profiles.", 'danger');

            const btn = document.getElementById('ypSaveBtn');
            btn.textContent = "Saving...";
            btn.disabled = true;

            const id = document.getElementById('ypEditId').value;
            
            try {
                let pic_url = undefined;
                if(document.getElementById('ypImage').files.length > 0) {
                    pic_url = await uploadImage('ypImage');
                }

                const payload = {
                    name: document.getElementById('ypName').value,
                    barangay: document.getElementById('ypBarangay').value,
                    gender: document.getElementById('ypGender').value,
                    status: document.getElementById('ypStatus').value
                };
                if (pic_url !== undefined) payload.pic_url = pic_url;

                if (id) {
                    const { error } = await sb.from('yp_profiles').update(payload).eq('id', id);
                    if(error) throw error;
                    showUserMessage("YP Profile updated.", 'success');
                } else {
                    const { error } = await sb.from('yp_profiles').insert([payload]);
                    if(error) throw error;
                    showUserMessage("YP Profile added.", 'success');
                }

                resetYPForm();
                // Refresh list after saving, maintaining current search term if any
                fetchYPs(document.getElementById('searchInput').value);
            } catch (err) {
                showUserMessage("Error saving YP: " + err.message, 'danger');
            } finally {
                btn.textContent = "Save Profile";
                btn.disabled = false;
            }
        });
        
        // 3. Edit Helper YP
        async function editYP(id) {
            if (!isAdmin) return;
            const { data } = await sb.from('yp_profiles').select('*').eq('id', id).single();
            if(data) {
                document.getElementById('ypEditId').value = data.id;
                document.getElementById('ypName').value = data.name;
                document.getElementById('ypBarangay').value = data.barangay;
                document.getElementById('ypGender').value = data.gender;
                document.getElementById('ypStatus').value = data.status;
                document.getElementById('ypSaveBtn').textContent = "Update Profile";
                document.getElementById('ypCancelBtn').style.display = "inline-block";
                document.getElementById('admin_yps').scrollIntoView({ behavior: 'smooth' });
            }
        }

        async function deleteYP(id) {
            if (!isAdmin || !showConfirmation("Delete this profile?")) return;
            const { error } = await sb.from('yp_profiles').delete().eq('id', id);
            if(error) showUserMessage(error.message, 'danger');
            else {
                showUserMessage("Profile deleted.", 'success');
                fetchYPs(document.getElementById('searchInput').value); // Refresh list with current search term
            }
        }
        
        function resetYPForm() {
            document.getElementById('ypForm').reset();
            document.getElementById('ypEditId').value = '';
            document.getElementById('ypSaveBtn').textContent = "Save Profile";
            document.getElementById('ypCancelBtn').style.display = "none";
        }


        // === UI NAVIGATION ===
        function showSection(sectionId, element) {
            document.querySelectorAll('main > section').forEach(sec => sec.classList.add('hidden'));
            const target = document.getElementById(sectionId);
            if(target) {
                target.classList.remove('hidden');
                target.classList.add('fade-in');
            }
            const titles = {
                'dashboard': 'Dashboard',
                'schedule_full': 'Conference Schedule',
                'registration': 'Registration',
                'settings': 'Settings',
                'admin_yps': 'Manage Profiles',
                'admin_announcements': 'Content Manager'
            };
            document.getElementById('pageTitle').textContent = titles[sectionId] || 'Portal';
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            if(element) element.classList.add('active');
            
            // Clear search when switching sections 
            document.getElementById('searchInput').value = '';

            // If switching to admin section, check/load data
            if (sectionId.startsWith('admin_')) {
                if (isAdmin) {
                    if (sectionId === 'admin_yps') fetchYPs('');
                    if (sectionId === 'admin_announcements') fetchAdminAnnouncements();
                } else {
                     // Display access denied if not admin
                     const gridId = sectionId === 'admin_yps' ? 'ypGrid' : 'adminAnnouncementList';
                     document.getElementById(gridId).innerHTML = `<p style="color: var(--danger-color)">Admin access required to view and manage this content.</p>`;
                }
            }


            if(window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('active');
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        // === AUTH MODALS (LOGIN & SETUP) ===
        
        // Login Modal Handlers
        function openLoginModal() { 
            closeSetupModal(false); // Ensure register is closed
            document.getElementById('loginModal').style.display = 'flex'; 
        }
        function closeLoginModal(reset = true) { 
            document.getElementById('loginModal').style.display = 'none'; 
            if (reset) {
                document.getElementById('loginError').style.display = 'none';
                document.getElementById('loginForm').reset();
            }
        }

        // Setup/Sign Up Modal Handlers
        function openSetupModal() { 
            closeLoginModal(false); // Ensure login is closed
            document.getElementById('setupModal').style.display = 'flex'; 
        }
        function closeSetupModal(reset = true) { 
            document.getElementById('setupModal').style.display = 'none'; 
            if (reset) {
                document.getElementById('setupError').style.display = 'none';
                document.getElementById('setupForm').reset();
            }
        }


        // Regular Login Submission
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btn = document.getElementById('loginSubmitBtn');
            const err = document.getElementById('loginError');

            btn.disabled = true;
            btn.textContent = "Signing In...";
            err.style.display = 'none';

            const { data, error } = await sb.auth.signInWithPassword({ email, password });

            if (error) {
                err.textContent = error.message;
                err.style.display = 'block';
                btn.disabled = false;
                btn.textContent = "Sign In";
            } else {
                handleUserLogin(data.user);
            }
        });

        // First-Time Admin Setup/Sign Up Submission
        document.getElementById('setupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('setupEmail').value;
            const password = document.getElementById('setupPassword').value;
            const btn = document.getElementById('setupSubmitBtn');
            const setupErrorEl = document.getElementById('setupError');

            btn.disabled = true;
            btn.textContent = "Creating Account...";
            setupErrorEl.style.display = 'none';
            
            try {
                // 1. Sign Up the new user
                const { data: authData, error: authError } = await sb.auth.signUp({ 
                    email, 
                    password 
                });

                if (authError) throw authError;

                // Supabase may require email confirmation; if authData.user is not present immediately,
                // do not attempt to insert admin_users or auto-login. Instead, show a message.
                const newUser = authData.user || null;
                if (!newUser) {
                    // Sign-up accepted but confirmation required (email sent)
                    setupErrorEl.textContent = "Account created. Please check your email to confirm the account before logging in.";
                    setupErrorEl.style.color = "var(--text-main)";
                    setupErrorEl.style.display = 'block';
                    btn.disabled = false;
                    btn.textContent = "Create Admin & Login";
                    // Show setup button so user can retry later
                    document.getElementById('adminSetupBtn').classList.remove('hidden');
                    return;
                }

                // 2. Grant admin rights in the custom table
                const { error: adminError } = await sb
                    .from('admin_users')
                    .insert({ id: newUser.id, email: newUser.email, is_admin: true });

                if (adminError) {
                    console.error("Failed to mark user as admin in DB:", adminError);
                    throw new Error("Account created, but failed to grant admin access. Check your database structure.");
                }

                showUserMessage("Admin account successfully created and logged in!", 'success');
                handleUserLogin(newUser);
                initializeAuthAndUI(); // Re-initialize UI state

            } catch (err) {
                // err is the caught exception; show it in the setupErrorEl
                setupErrorEl.textContent = err.message || "An unknown error occurred during setup.";
                setupErrorEl.style.display = 'block';
                btn.disabled = false;
                btn.textContent = "Create Admin & Login";
                // Ensure correct button is shown if setup failed
                document.getElementById('adminSetupBtn').classList.remove('hidden');
            }
        });

        // Simple Message Box implementation (replaces alert/confirm)
        function showUserMessage(message, type = 'info') {
             // IMPORTANT: In a production environment, implement a custom modal or toast notification.
            if (type === 'danger') {
                 alert(`Error: ${message}`);
            } else {
                 alert(`Success: ${message}`);
            }
        }
        
        function showConfirmation(message) {
            // IMPORTANT: In a production environment, implement a custom modal instead of standard confirm.
            return confirm(message);
        }


        window.onclick = function(event) {
            if (event.target == document.getElementById('loginModal')) closeLoginModal();
            if (event.target == document.getElementById('setupModal')) closeSetupModal();
        }
    </script>
</body>
</html>
